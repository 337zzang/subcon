# ğŸ¨ íƒœìŠ¤í¬ ì„¤ê³„ì„œ

## ğŸ“‹ ê¸°ë³¸ ì •ë³´
- **í”„ë¡œì íŠ¸**: subcon
- **í”Œëœ**: ìºì‹œ ê¸°ëŠ¥ ë° ë‚ ì§œ ì²˜ë¦¬ ì˜¤ë¥˜ ìˆ˜ì •
- **íƒœìŠ¤í¬ ë²ˆí˜¸**: 02
- **íƒœìŠ¤í¬ ID**: b79483ad-3438-4ecc-8163-7951fff36fe0
- **íƒœìŠ¤í¬ëª…**: êµ­ì„¸ì²­ì‘ì„±ì¼ ë‚ ì§œ ì²˜ë¦¬ ì˜¤ë¥˜ ë¶„ì„ ë° ìˆ˜ì •
- **ì‘ì„±ì¼**: 2025-07-14
- **ì‘ì„±ì**: AI Assistant
- **ë¬¸ì„œ ê²½ë¡œ**: C:\Users\Administrator\Desktop\subcon\docs\design\cache_and_date_fix_task02_date_processing_design_20250714.md

## ğŸ¯ ì„¤ê³„ ëª©ì 
### ìš”êµ¬ì‚¬í•­
ë…¸íŠ¸ë¶ê³¼ ë™ì¼í•œ êµ¬ì¡°ë¡œ ëŒ€ì‚¬ë¥¼ ì²˜ë¦¬í•˜ê³ , ë‚ ì§œ ì²˜ë¦¬ ë¶€ë¶„ë„ ë…¸íŠ¸ë¶ì˜ ë°ì´í„°í”„ë ˆì„ ì¡°ì • ë¶€ë¶„ê³¼ ë™ì¼í•˜ê²Œ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.

### AIì˜ ì´í•´
í˜„ì¬ ë¬¸ì œ:
1. MultiIndex ì»¬ëŸ¼ ì²˜ë¦¬ë¡œ 'êµ­ì„¸ì²­ì‘ì„±ì¼'ì´ 'nan_ì‘ì„±ì¼'ë¡œ ë³€í™˜ë¨
2. í•˜ë“œì½”ë”©ëœ ì»¬ëŸ¼ ë§¤í•‘ìœ¼ë¡œ ì¸í•œ KeyError
3. None íƒ€ì… ë‚ ì§œ ì²˜ë¦¬ ì‹œ 'total_seconds' ì—ëŸ¬

### í•´ê²°í•˜ë ¤ëŠ” ë¬¸ì œ
1. ë§¤ì…ì„¸ê¸ˆê³„ì‚°ì„œì˜ MultiIndex ì»¬ëŸ¼ ì˜¬ë°”ë¥¸ ì²˜ë¦¬
2. ë™ì  ì»¬ëŸ¼ ë§¤í•‘ìœ¼ë¡œ í•˜ë“œì½”ë”© ì œê±°
3. None íƒ€ì… ë‚ ì§œì— ëŒ€í•œ ì•ˆì „í•œ ì²˜ë¦¬

## ğŸ” í˜„ì¬ ì‹œìŠ¤í…œ ë¶„ì„
### ë¬¸ì œê°€ ë˜ëŠ” ì½”ë“œ
```python
# í˜„ì¬: í•˜ë“œì½”ë”©ëœ ë§¤í•‘
column_mapping = {
    'êµ­ì„¸ì²­ìŠ¹ì¸ë²ˆí˜¸': 'êµ­ì„¸ì²­ìŠ¹ì¸ë²ˆí˜¸',
    'ì—…ì²´ì‚¬ì—…ìë²ˆí˜¸': 'ì—…ì²´ì‚¬ì—…ìë²ˆí˜¸',
    'êµ­ì„¸ì²­ì‘ì„±ì¼': 'nan_ì‘ì„±ì¼',  # ì˜ëª»ëœ ë§¤í•‘!
    'êµ­ì„¸ì²­ë°œê¸‰ì¼': 'nan_ë°œê¸‰ì¼'     # ì˜ëª»ëœ ë§¤í•‘!
}
```

### ë…¸íŠ¸ë¶ì˜ ì›ë˜ ë°©ì‹
```python
# ë…¸íŠ¸ë¶: MultiIndex ì²˜ë¦¬ í›„ ë™ì  ë§¤í•‘
# 1. MultiIndex í‰íƒ„í™”
df.columns = [col if isinstance(col, str) else col[0] for col in df.columns]

# 2. ì‹¤ì œ ì»¬ëŸ¼ëª… í™•ì¸
actual_columns = df.columns.tolist()

# 3. íŒ¨í„´ ë§¤ì¹­ìœ¼ë¡œ ì»¬ëŸ¼ ì°¾ê¸°
date_columns = [col for col in actual_columns if 'ì‘ì„±ì¼' in col]
```

## ğŸ’¡ êµ¬í˜„ ë°©í–¥
### ì ‘ê·¼ ë°©ë²•
1. **MultiIndex ì»¬ëŸ¼ ì²˜ë¦¬ ê°œì„ **
   ```python
   def flatten_multiindex_columns(df):
       '''MultiIndex ì»¬ëŸ¼ì„ ì•ˆì „í•˜ê²Œ í‰íƒ„í™”'''
       if isinstance(df.columns, pd.MultiIndex):
           # ì²« ë²ˆì§¸ ë ˆë²¨ë§Œ ì‚¬ìš© (ë…¸íŠ¸ë¶ ë°©ì‹)
           df.columns = [col[0] for col in df.columns.values]
       return df
   ```

2. **ë™ì  ì»¬ëŸ¼ ë§¤í•‘**
   ```python
   def find_column_by_pattern(df, patterns):
       '''íŒ¨í„´ìœ¼ë¡œ ì»¬ëŸ¼ ì°¾ê¸°'''
       for pattern in patterns:
           matches = [col for col in df.columns if pattern in str(col)]
           if matches:
               return matches[0]
       return None

   # ì‚¬ìš© ì˜ˆ
   ì‘ì„±ì¼_ì»¬ëŸ¼ = find_column_by_pattern(df, ['êµ­ì„¸ì²­ì‘ì„±ì¼', 'ì‘ì„±ì¼', 'ì‘ì„±ë‚ ì§œ'])
   ë°œê¸‰ì¼_ì»¬ëŸ¼ = find_column_by_pattern(df, ['êµ­ì„¸ì²­ë°œê¸‰ì¼', 'ë°œê¸‰ì¼', 'ë°œê¸‰ë‚ ì§œ'])
   ```

3. **ì•ˆì „í•œ ë‚ ì§œ ì²˜ë¦¬**
   ```python
   def safe_date_conversion(series):
       '''Noneê³¼ timezoneì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬'''
       if series is None or series.isna().all():
           return None

       # datetime ë³€í™˜
       converted = pd.to_datetime(series, errors='coerce')

       # timezone ì œê±° (ìˆëŠ” ê²½ìš°)
       if hasattr(converted, 'dt') and hasattr(converted.dt, 'tz'):
           converted = converted.dt.tz_localize(None)

       return converted
   ```

### ì£¼ìš” ë³€ê²½ì‚¬í•­
1. **reconciliation_service_v2.py - _process_tax_invoices() ìˆ˜ì •**
   ```python
   # MultiIndex ì²˜ë¦¬ ê°œì„ 
   if isinstance(self.df_tax_hifi.columns, pd.MultiIndex):
       self.df_tax_hifi.columns = [col[0] for col in self.df_tax_hifi.columns.values]

   # ë™ì  ì»¬ëŸ¼ ì°¾ê¸°
   ì‘ì„±ì¼_ì»¬ëŸ¼ = find_column_by_pattern(self.df_tax_hifi, ['êµ­ì„¸ì²­ì‘ì„±ì¼', 'ì‘ì„±ì¼'])
   ë°œê¸‰ì¼_ì»¬ëŸ¼ = find_column_by_pattern(self.df_tax_hifi, ['êµ­ì„¸ì²­ë°œê¸‰ì¼', 'ë°œê¸‰ì¼'])

   # ì•ˆì „í•œ ë§¤í•‘
   if ì‘ì„±ì¼_ì»¬ëŸ¼ and ë°œê¸‰ì¼_ì»¬ëŸ¼:
       column_mapping = {
           'êµ­ì„¸ì²­ìŠ¹ì¸ë²ˆí˜¸': 'êµ­ì„¸ì²­ìŠ¹ì¸ë²ˆí˜¸',
           'ì—…ì²´ì‚¬ì—…ìë²ˆí˜¸': 'ì—…ì²´ì‚¬ì—…ìë²ˆí˜¸',
           'êµ­ì„¸ì²­ì‘ì„±ì¼': ì‘ì„±ì¼_ì»¬ëŸ¼,
           'êµ­ì„¸ì²­ë°œê¸‰ì¼': ë°œê¸‰ì¼_ì»¬ëŸ¼
       }
   ```

2. **ë‚ ì§œ ì²˜ë¦¬ ë¡œì§ ê°œì„ **
   ```python
   # ì‘ì„±ë…„ë„, ì‘ì„±ì›” ì¶”ì¶œ
   if 'êµ­ì„¸ì²­ì‘ì„±ì¼' in self.df_tax_new.columns:
       date_col = safe_date_conversion(self.df_tax_new['êµ­ì„¸ì²­ì‘ì„±ì¼'])
       if date_col is not None:
           self.df_tax_new['ì‘ì„±ë…„ë„'] = date_col.dt.year
           self.df_tax_new['ì‘ì„±ì›”'] = date_col.dt.month
       else:
           # ê³„ì‚°ì„œì‘ì„±ì¼ ì‚¬ìš© (í´ë°±)
           self._use_fallback_date()
   ```

## âš ï¸ ì˜í–¥ë„ ë¶„ì„
### ì§ì ‘ ì˜í–¥
- **ë³€ê²½ íŒŒì¼**: 
  - src/services/reconciliation_service_v2.py (_process_tax_invoices, _process_matching)
- **ìƒˆ íŒŒì¼**: ì—†ìŒ
- **ì‚­ì œ íŒŒì¼**: ì—†ìŒ

### ê°„ì ‘ ì˜í–¥
- **ì•ˆì •ì„±**: í¬ê²Œ í–¥ìƒ (ë™ì  ë§¤í•‘ìœ¼ë¡œ ì»¬ëŸ¼ëª… ë³€ê²½ì— ëŒ€ì‘)
- **ì„±ëŠ¥**: ë³€í™” ì—†ìŒ
- **ì •í™•ë„**: í–¥ìƒ (ë‚ ì§œ ì²˜ë¦¬ ì˜¤ë¥˜ í•´ê²°)

### í•˜ìœ„ í˜¸í™˜ì„±
ì™„ì „íˆ ìœ ì§€ë¨. ê¸°ì¡´ ë°ì´í„°ë„ ì •ìƒ ì²˜ë¦¬ë¨.

## ğŸ›¡ï¸ ë¦¬ìŠ¤í¬ ê´€ë¦¬
| ë¦¬ìŠ¤í¬ | ê°€ëŠ¥ì„± | ì˜í–¥ë„ | ëŒ€ì‘ ë°©ì•ˆ |
|--------|--------|--------|-----------|
| ì»¬ëŸ¼ëª… íŒ¨í„´ ë¶ˆì¼ì¹˜ | ë‚®ìŒ | ë†’ìŒ | ë‹¤ì–‘í•œ íŒ¨í„´ ì¶”ê°€ |
| ë‚ ì§œ í˜•ì‹ ë¶ˆì¼ì¹˜ | ì¤‘ê°„ | ì¤‘ê°„ | pd.to_datetimeì˜ format ì˜µì…˜ í™œìš© |
| None íƒ€ì… ì²˜ë¦¬ | ë‚®ìŒ | ë‚®ìŒ | ëª¨ë“  ë‹¨ê³„ì—ì„œ None ì²´í¬ |

## ğŸ“Š ì˜ˆìƒ ê²°ê³¼
### ì„±ê³µ ê¸°ì¤€
- [x] MultiIndex ì»¬ëŸ¼ ì •ìƒ ì²˜ë¦¬
- [x] êµ­ì„¸ì²­ì‘ì„±ì¼ ì •ìƒ ì¸ì‹
- [x] ë‚ ì§œ ë³€í™˜ ì—ëŸ¬ ì—†ìŒ
- [x] ëŒ€ì‚¬ ì²˜ë¦¬ ì •ìƒ ì‘ë™

### ì˜ˆìƒ ì†Œìš” ì‹œê°„
- êµ¬í˜„: 30ë¶„
- í…ŒìŠ¤íŠ¸: 20ë¶„
- ë¬¸ì„œí™”: 10ë¶„

## âœ… ê²€ì¦ ê³„íš
### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
1. MultiIndex ì»¬ëŸ¼ íŒŒì¼ í…ŒìŠ¤íŠ¸
2. ë‹¤ì–‘í•œ ë‚ ì§œ í˜•ì‹ í…ŒìŠ¤íŠ¸
3. None ê°’ í¬í•¨ ë°ì´í„° í…ŒìŠ¤íŠ¸
4. ì „ì²´ ëŒ€ì‚¬ í”„ë¡œì„¸ìŠ¤ í…ŒìŠ¤íŠ¸

### ë””ë²„ê·¸ ë¡œê·¸ í™•ì¸
```
âœ… ì„¸ê¸ˆê³„ì‚°ì„œ ì²˜ë¦¬ ì™„ë£Œ: 85ê±´
âš ï¸ ë‚ ì§œ ë³€í™˜ ê²½ê³ : [í•´ê²°ë¨]
âœ… êµ­ì„¸ì²­ì‘ì„±ì¼ ì •ìƒ ì‚¬ìš©
```

## ğŸ“š ì°¸ê³  ìë£Œ
- pandas MultiIndex ë¬¸ì„œ
- pd.to_datetime ì˜µì…˜
- ë…¸íŠ¸ë¶ì˜ ì›ë˜ êµ¬ì¡°
